# í•˜ë£¨ í•œ ë¬¸ì¥ - ë°±ì—”ë“œ ì„¤ê³„ì„œ

## ğŸ“‹ ëª©ì°¨
1. [ì•„í‚¤í…ì²˜ ê°œìš”](#ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
3. [API ì„¤ê³„](#api-ì„¤ê³„)
4. [ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§](#ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§)
5. [ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ](#ìŠ¤ì¼€ì¤„ë§-ì‹œìŠ¤í…œ)
6. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
7. [ì—ëŸ¬ ì²˜ë¦¬](#ì—ëŸ¬-ì²˜ë¦¬)
8. [í…ŒìŠ¤íŠ¸ ì „ëµ](#í…ŒìŠ¤íŠ¸-ì „ëµ)

---

## ì•„í‚¤í…ì²˜ ê°œìš”

### ğŸ—ï¸ Firebase Functions ê¸°ë°˜ ì„œë²„ë¦¬ìŠ¤
```
ğŸ“± Frontend â†’ ğŸŒ API Gateway â†’ âš¡ Cloud Functions â†’ ğŸ—„ï¸ Firestore
                                    â†“
                               â° Schedulers
```

**ì„ íƒ ì´ìœ :**
- ì„œë²„ ê´€ë¦¬ ë¶ˆí•„ìš”
- ìë™ ìŠ¤ì¼€ì¼ë§
- Google ìƒíƒœê³„ í†µí•©
- ë¹„ìš© íš¨ìœ¨ì„±

### ğŸ“¦ ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜
```typescript
// functions/src/index.ts
export const api = onRequest(require('./api/router'));
export const selectDailyQuote = onSchedule('0 0 * * *',
  require('./schedulers/dailyQuoteSelector'));
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### ğŸ—„ï¸ Firestore ì»¬ë ‰ì…˜ êµ¬ì¡°
```typescript
// quotes ì»¬ë ‰ì…˜
interface Quote {
  id: string;
  type: 'quote' | 'text';
  content: string;
  like_count: number;
  last_shown_date: string;
  status: 'published' | 'hidden';
  created_at: Timestamp;
  updated_at: Timestamp;
}

// submissions ì»¬ë ‰ì…˜
interface Submission {
  content: string;
  status: 'pending' | 'approved' | 'rejected';
  created_at: Timestamp;
  user_ip?: string;
}

// daily_quotes ì»¬ë ‰ì…˜
interface DailyQuote {
  date: string; // ë¬¸ì„œ ID
  quote_id: string;
  selected_at: Timestamp;
}
```

### ğŸ”’ ë³´ì•ˆ ê·œì¹™
```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /quotes/{quoteId} {
      allow read: if resource.data.status == 'published';
      allow write: if isAdmin();
    }

    match /submissions/{submissionId} {
      allow create: if isValidSubmission(request.resource.data);
      allow read, update, delete: if isAdmin();
    }
  }
}
```

### ğŸ“Š ì¸ë±ìŠ¤ ìµœì í™”
```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "quotes",
      "fields": [
        {"fieldPath": "status", "order": "ASCENDING"},
        {"fieldPath": "last_shown_date", "order": "ASCENDING"}
      ]
    }
  ]
}
```

---

## API ì„¤ê³„

### ğŸŒ RESTful ì—”ë“œí¬ì¸íŠ¸
```typescript
// API êµ¬ì¡°
GET  /v1/quotes/today     # ì˜¤ëŠ˜ì˜ ê¸€ ì¡°íšŒ
GET  /v1/quotes/random    # ëœë¤ ê¸€ ì¡°íšŒ
POST /v1/quotes/:id/like  # ê¸€ ê³µê°í•˜ê¸°
POST /v1/submissions      # ê¸€ ì œì¶œ
GET  /v1/health          # í—¬ìŠ¤ì²´í¬
```

### ğŸ“¡ API ì‘ë‹µ í˜•ì‹
```typescript
// ì„±ê³µ ì‘ë‹µ
{
  "data": {
    "id": "quote_123",
    "content": "ê°€ì¥ ì–´ë‘ìš´ ë°¤ë„ ê³§ ëë‚  ê²ƒì´ë‹¤.",
    "like_count": 42
  },
  "timestamp": "2024-09-24T12:00:00Z"
}

// ì—ëŸ¬ ì‘ë‹µ
{
  "error": "QUOTE_NOT_FOUND",
  "message": "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
  "timestamp": "2024-09-24T12:00:00Z"
}
```

### ğŸ›¡ï¸ ë¯¸ë“¤ì›¨ì–´ ì²´ì¸
```typescript
// api/router.ts
router.use(corsHandler);
router.use(rateLimiter);
router.use(validateRequest);
router.use(cacheMiddleware);
router.use(errorHandler);
```

---

## ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### ğŸ“‹ ì„œë¹„ìŠ¤ ë ˆì´ì–´ êµ¬ì¡°
```
services/
â”œâ”€â”€ QuoteService.ts      # ê¸€ ê´€ë ¨ ë¡œì§
â”œâ”€â”€ SubmissionService.ts # ì œì¶œ ê´€ë ¨ ë¡œì§
â”œâ”€â”€ CacheService.ts      # ìºì‹± ë¡œì§
â””â”€â”€ AnalyticsService.ts  # ë¶„ì„ ë¡œì§
```

### ğŸ¯ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
```typescript
class QuoteService {
  // 1. ì˜¤ëŠ˜ì˜ ê¸€ ì¡°íšŒ (ìºì‹œ ìš°ì„ )
  async getTodaysQuote(): Promise<Quote | null> {
    // L1: ë©”ëª¨ë¦¬ ìºì‹œ â†’ L2: Redis â†’ L3: DB
    const cached = await this.cacheService.get(`daily-${today}`);
    if (cached) return cached;

    const dailyQuote = await this.repository.getDailyQuote(today);
    if (!dailyQuote) {
      await this.selectDailyQuote(); // ìë™ ì„ ì •
    }

    return await this.repository.getById(dailyQuote.quote_id);
  }

  // 2. ê³µê°í•˜ê¸° (ì¤‘ë³µ ë°©ì§€)
  async incrementLike(quoteId: string, userIp: string) {
    const likeKey = `like-${quoteId}-${this.hashIP(userIp)}`;
    const lastLike = await this.cacheService.get(likeKey);

    if (this.isWithin24Hours(lastLike)) {
      return { success: false, error: 'LIKE_TOO_SOON' };
    }

    const result = await this.repository.incrementLikeCount(quoteId);
    await this.cacheService.set(likeKey, new Date(), 86400); // 24ì‹œê°„

    return { success: true, like_count: result.like_count };
  }
}
```

### ğŸ² ê¸€ ì„ ì • ì•Œê³ ë¦¬ì¦˜
```typescript
// ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ ì„ íƒ
selectQuoteWithWeights(quotes: Quote[]): Quote {
  const weights = quotes.map(quote => {
    let weight = 1;
    weight += Math.max(0, 50 - quote.like_count) * 0.1; // ì¢‹ì•„ìš” ì ìœ¼ë©´ ê°€ì¤‘ì¹˜ ì¦ê°€
    weight += this.getDaysSince(quote.last_shown_date) * 0.05; // ì˜¤ë˜ë ìˆ˜ë¡ ê°€ì¤‘ì¹˜ ì¦ê°€
    return weight;
  });

  return this.weightedRandom(quotes, weights);
}
```

---

## ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ

### â° ì¼ì¼ ê¸€ ì„ ì • ìŠ¤ì¼€ì¤„ëŸ¬
```typescript
// schedulers/dailyQuoteSelector.ts
export const selectDailyQuote = onSchedule({
  schedule: '0 0 * * *', // ë§¤ì¼ ìì •
  timeZone: 'Asia/Seoul'
}, async (event) => {
  try {
    const today = new Date().toISOString().split('T')[0];

    // ë©±ë“±ì„± ì²´í¬
    const existing = await getDailyQuote(today);
    if (existing) {
      console.log(`Already selected: ${existing.quote_id}`);
      return;
    }

    // 100ì¼ ì´ë‚´ ë…¸ì¶œë˜ì§€ ì•Šì€ ê¸€ ì¡°íšŒ
    const cutoffDate = getDateBefore(100);
    const availableQuotes = await getAvailableQuotes(cutoffDate);

    if (availableQuotes.length === 0) {
      // í´ë°±: ê°€ì¥ ì˜¤ë˜ëœ ê¸€ ì¬ì‚¬ìš©
      availableQuotes = await getOldestShownQuotes();
    }

    const selectedQuote = selectWithWeights(availableQuotes);

    // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¼ê´€ì„± ë³´ì¥
    await db.runTransaction(async (t) => {
      t.set(dailyQuoteRef, {
        date: today,
        quote_id: selectedQuote.id,
        selected_at: new Date()
      });

      t.update(quoteRef, {
        last_shown_date: today
      });
    });

  } catch (error) {
    await notifyAdmins('daily_quote_selection_failed', error);
    throw error; // Functions ì¬ì‹œë„
  }
});
```

### ğŸ§¹ ì •ê¸° ìœ ì§€ë³´ìˆ˜
```typescript
// ì£¼ê°„ ì •ë¦¬ ì‘ì—…
export const weeklyMaintenance = onSchedule('0 2 * * 0', async () => {
  await Promise.allSettled([
    cleanupOldSubmissions(90), // 90ì¼ ì´ìƒ ê±°ì ˆëœ ì œì¶œê¸€ ì‚­ì œ
    optimizeQuoteStats(),      // í†µê³„ ìµœì í™”
    generateWeeklyReport()     // ì£¼ê°„ ë¦¬í¬íŠ¸
  ]);
});
```

---

## ì„±ëŠ¥ ìµœì í™”

### âš¡ ë‹¤ì¸µ ìºì‹± ì „ëµ
```typescript
class CacheService {
  // L1: ë©”ëª¨ë¦¬ ìºì‹œ (5ë¶„, 1000ê°œ ì œí•œ)
  private memoryCache = new Map<string, CacheItem>();

  // L2: Redis ìºì‹œ (1ì‹œê°„)
  private redis = new Redis(process.env.REDIS_URL);

  async get<T>(key: string): Promise<T | null> {
    // 1ë‹¨ê³„: ë©”ëª¨ë¦¬ ìºì‹œ
    const memory = this.memoryCache.get(key);
    if (memory && !this.isExpired(memory)) {
      return memory.value;
    }

    // 2ë‹¨ê³„: Redis ìºì‹œ
    const redis = await this.redis.get(key);
    if (redis) {
      const value = JSON.parse(redis);
      this.setMemoryCache(key, value);
      return value;
    }

    return null;
  }
}
```

### ğŸ”„ ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
```typescript
// Firestore ì½ê¸° ë¹„ìš© ìµœì í™”
async getQuotesByIds(ids: string[]): Promise<Map<string, Quote>> {
  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cached = await this.cacheService.mget(ids.map(id => `quote:${id}`));

  // ìºì‹œì— ì—†ëŠ” ê²ƒë§Œ ë°°ì¹˜ ì¡°íšŒ
  const missedIds = ids.filter(id => !cached.has(`quote:${id}`));

  if (missedIds.length > 0) {
    const batchSize = 10; // Firestore ì œí•œ
    const batches = chunk(missedIds, batchSize);

    const results = await Promise.all(
      batches.map(batch => this.db.getAll(...batch.map(id =>
        this.db.collection('quotes').doc(id)
      )))
    );

    // ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥
    results.flat().forEach(doc => {
      if (doc.exists) {
        this.cacheService.set(`quote:${doc.id}`, doc.data(), 3600);
      }
    });
  }
}
```

### ğŸ“Š ì‘ë‹µ ì••ì¶• ë° ìºì‹±
```typescript
// HTTP ë ˆë²¨ ìµœì í™”
app.use(compression({
  threshold: 1024,
  level: 6
}));

app.use('/v1/quotes/today', cacheMiddleware(1800)); // 30ë¶„ ìºì‹±
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### ğŸš¨ êµ¬ì¡°í™”ëœ ì—ëŸ¬ ì‹œìŠ¤í…œ
```typescript
export class AppError extends Error {
  constructor(
    public code: ErrorCode,
    message: string,
    public statusCode: number,
    public isOperational: boolean = true
  ) {
    super(message);
  }

  toResponse() {
    return {
      error: this.code,
      message: this.message,
      timestamp: new Date().toISOString()
    };
  }
}

// ì—ëŸ¬ íƒ€ì…ë“¤
export enum ErrorCode {
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  RESOURCE_NOT_FOUND = 'RESOURCE_NOT_FOUND',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
  INTERNAL_ERROR = 'INTERNAL_ERROR'
}
```

### ğŸ“ êµ¬ì¡°í™”ëœ ë¡œê¹…
```typescript
class Logger {
  // ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë²¤íŠ¸
  logBusinessEvent(event: string, data: object) {
    this.winston.info(`Business Event: ${event}`, {
      eventType: 'business',
      eventName: event,
      eventData: data,
      requestId: this.requestId
    });
  }

  // ì„±ëŠ¥ ë¡œê¹…
  logPerformance(operation: string, duration: number) {
    this.winston.info(`Performance: ${operation}`, {
      eventType: 'performance',
      operation,
      duration,
      requestId: this.requestId
    });
  }
}
```

### ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ
```typescript
// ì‹¬ê°í•œ ì˜¤ë¥˜ ì‹œ Slack ì•Œë¦¼
async notifyAdmins(event: string, data: object) {
  const payload = {
    text: `ğŸš¨ Daily Quote Backend Alert`,
    attachments: [{
      color: 'danger',
      fields: [
        {title: 'Event', value: event},
        {title: 'Details', value: JSON.stringify(data)}
      ]
    }]
  };

  await fetch(process.env.SLACK_WEBHOOK_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  });
}
```

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### ğŸ§ª í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ
```
E2E Tests (10%)     - ì „ì²´ ì›Œí¬í”Œë¡œìš°
Integration (20%)   - API í†µí•© í…ŒìŠ¤íŠ¸
Unit Tests (70%)    - ê°œë³„ í•¨ìˆ˜/í´ë˜ìŠ¤
```

### ğŸ”§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
```typescript
describe('QuoteService', () => {
  let service: QuoteService;
  let mockRepository: jest.Mocked<QuoteRepository>;

  beforeEach(() => {
    mockRepository = createMockRepository();
    service = new QuoteService(mockRepository);
  });

  it('ì˜¤ëŠ˜ì˜ ê¸€ì„ ìºì‹œì—ì„œ ë°˜í™˜í•´ì•¼ í•œë‹¤', async () => {
    // Arrange
    mockRepository.getDailyQuote.mockResolvedValue(mockQuote);

    // Act
    const result = await service.getTodaysQuote();

    // Assert
    expect(result).toEqual(mockQuote);
  });
});
```

### ğŸŒ í†µí•© í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
```typescript
describe('Quotes API', () => {
  it('ì˜¤ëŠ˜ì˜ ê¸€ì„ ë°˜í™˜í•´ì•¼ í•œë‹¤', async () => {
    const response = await request(app)
      .get('/v1/quotes/today')
      .expect(200);

    expect(response.body.data).toHaveProperty('content');
    expect(response.headers['cache-control']).toContain('max-age');
  });
});
```

### ğŸ“Š í’ˆì§ˆ ë©”íŠ¸ë¦­
```json
{
  "coverageThreshold": {
    "global": {
      "branches": 80,
      "functions": 85,
      "lines": 85,
      "statements": 85
    }
  }
}
```

---

## ğŸ“ˆ í•µì‹¬ ì„¤ê³„ ê²°ì •

| ì˜ì—­ | ì„ íƒ | ì´ìœ  |
|------|------|------|
| **ì•„í‚¤í…ì²˜** | Firebase Functions | ì„œë²„ë¦¬ìŠ¤, ìë™ ìŠ¤ì¼€ì¼ë§ |
| **ë°ì´í„°ë² ì´ìŠ¤** | Firestore | NoSQL ìœ ì—°ì„±, ì‹¤ì‹œê°„ ë™ê¸°í™” |
| **ìºì‹±** | ë©”ëª¨ë¦¬ + Redis | ë‹¤ì¸µ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™” |
| **ì—ëŸ¬ ì²˜ë¦¬** | êµ¬ì¡°í™”ëœ ì—ëŸ¬ í´ë˜ìŠ¤ | ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬ |
| **ë¡œê¹…** | Winston + êµ¬ì¡°í™” | ë””ë²„ê¹…ê³¼ ëª¨ë‹ˆí„°ë§ ìµœì í™” |
| **í…ŒìŠ¤íŠ¸** | Jest + Supertest | í¬ê´„ì  í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ |

## ğŸš€ í™•ì¥ì„± ê³ ë ¤ì‚¬í•­

- **ìºì‹± ì „ëµ**: ë‹¤ì¸µ ìºì‹œë¡œ ì½ê¸° ì„±ëŠ¥ ê·¹ëŒ€í™”
- **ë°°ì¹˜ ì²˜ë¦¬**: Firestore ë¹„ìš© ìµœì í™”
- **ì—ëŸ¬ ë³µêµ¬**: ìë™ ì¬ì‹œë„ ë° í´ë°± ë©”ì»¤ë‹ˆì¦˜
- **ëª¨ë‹ˆí„°ë§**: ì„±ëŠ¥ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ì¶”ì 
- **í’ˆì§ˆ ë³´ì¥**: ë†’ì€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ì™€ ìë™í™”
